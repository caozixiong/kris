<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>First Grade Math Adventures V2</title>
    <style>
        /* Global Styles - keeping most from previous, with potential minor tweaks */
        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Arial', sans-serif;
            background-color: #e0f7fa; /* Light cyan background */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: auto;
            touch-action: manipulation;
        }

        #game-selector-area {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        #game-selector-area button {
            padding: 10px 15px;
            font-size: 15px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* New Color Scheme for 4 games */
        #select-game2 { background-color: #ff7043; } /* Coral - Shapes Math 1 */
        #select-game5 { background-color: #7e57c2; } /* Deep Purple - Potion Missing Addend */
        #select-game6 { background-color: #5c6bc0; } /* Indigo - Alien Jumps */
        #select-game7 { background-color: #00acc1; } /* Cyan - Fruit Money */


        #game-selector-area button:hover { transform: translateY(-2px); }
        #game-selector-area button.active { box-shadow: 0 0 0 3px #fff, 0 0 0 6px #4CAF50; transform: translateY(1px); }

        #score-area { display: flex; justify-content: space-between; width: 100%; max-width: 550px; margin-bottom: 15px; font-size: 18px; font-weight: bold; padding: 0 10px; }
        #score-area span { background-color: rgba(255,255,255,0.85); padding: 8px 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .game-host-container { width: 100%; display: flex; flex-direction: column; align-items: center; }
        
        /* --- Styles for Game 2 (Shapes Math 1 - Original) --- */
        /* These styles are largely unchanged from your previous working version */
        .game23-more-challenging-btn { margin-bottom: 10px; padding: 10px 15px; font-size: 16px; background-color: #ffc107; color: black; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background-color 0.2s; }
        .game23-more-challenging-btn:hover, .game23-more-challenging-btn:active { background-color: #e0a800; }
        .game23-game-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; background-color: white; border-radius: 20px; padding: 15px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); position: relative; }
        .game23-shapes-container { display: flex; justify-content: space-around; width: 100%; margin-bottom: 20px; min-height: 120px; }
        .game23-shape-group { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; width: 45%; padding: 10px; border: 2px dashed #70a1ff; border-radius: 10px; }
        .game23-shape { margin: 5px; font-size: 30px; }
        .game23-math-container { width: 100%; display: flex; flex-direction: column; align-items: center; }
        .game23-math-row { display: flex; align-items: center; width: 100%; margin: 5px 0; justify-content: center; }
        .game23-shape-icon { font-size: 24px; margin: 0 10px; }
        .game23-operator { font-size: 40px; margin: 5px 0; font-weight: bold; color: #2c3e50; }
        .game23-number-options { display: flex; justify-content: space-around; width: 60%; }
        .game23-number-option { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; background-color: #70a1ff; color: white; border-radius: 50%; font-size: 20px; cursor: pointer; user-select: none; transition: transform 0.2s, background-color 0.2s; }
        .game23-number-option:hover, .game23-number-option:active { transform: scale(1.1); background-color: #1e90ff; }
        .game23-number-option.selected { background-color: #27ae60; transform: scale(1.1); }
        .game23-number-option.wrong { background-color: #e74c3c; animation: game-shake 0.5s; }
        .game23-timer { position: absolute; top: 10px; right: 10px; font-size: 28px; font-weight: bold; color: #e74c3c; background-color: rgba(255, 255, 255, 0.7); padding: 5px 15px; border-radius: 20px; min-width: 90px; text-align: center; font-family: sans-serif; }

        /* Generic Result Popup (Used by all games) */
        .game-result-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(255, 255, 255, 0.95); z-index: 100; font-size: 50px; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .game-result-popup.show { opacity: 1; pointer-events: auto; }
        .game-result-emoji { font-size: 100px; margin-bottom: 20px; animation: emoji-pop 0.5s ease-out; }
        .game-result-text { font-size: 32px; font-weight: bold; text-align: center; }
        @keyframes game-shake { 0%, 100% { transform: translateX(0) scale(1.1); } 20%, 60% { transform: translateX(-5px) scale(1.1); } 40%, 80% { transform: translateX(5px) scale(1.1); } }
        @keyframes emoji-pop { 0% {transform: scale(0.5); opacity:0;} 70% {transform: scale(1.1); opacity:1;} 100% {transform: scale(1); opacity:1;} }

        /* --- Styles for Game 5 (Potion - Missing Addend) --- */
        #game5-host .game-container { background: url('https://www.transparenttextures.com/patterns/stardust.png'), linear-gradient(to bottom, #6a11cb, #2575fc); padding: 20px; border-radius: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); color: white; max-width: 480px; width: 95%; text-align: center;}
        #game5-host .problem-area { font-size: 2.2em; margin-bottom: 25px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; }
        #game5-host .ingredient, #game5-host .missing-ingredient, #game5-host .potion-total { background-color: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: 10px; margin: 5px; display: inline-block; min-width: 40px; }
        #game5-host .missing-ingredient { background-color: rgba(255,255,0,0.3); border: 2px dashed yellow; } /* Highlight missing */
        #game5-host .cauldron-icon { font-size: 2.5em; margin-right: 10px; animation: bubble 2s infinite ease-in-out; }
        @keyframes bubble { 0%, 100% {transform: scale(1) rotate(-2deg);} 50% {transform: scale(1.05) rotate(2deg);} }
        #game5-host .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 10px; width: 100%; }
        #game5-host .potion-option { background-color: #ff4081; color: white; padding: 18px; border-radius: 15px; font-size: 1.7em; cursor: pointer; transition: transform 0.2s, background-color 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #game5-host .potion-option:hover { transform: scale(1.05); background-color: #f50057; }

        /* --- Styles for Game 6 (Alien Rescue - Jumps) --- */
        #game6-host .game-container { background: url('https://www.transparenttextures.com/patterns/starring.png'), #0c0e30; /* Darker space */ padding: 20px; border-radius: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); color: #e0e0e0; max-width: 520px; width: 95%; text-align: center; }
        #game6-host .mission-info { font-size: 1.3em; margin-bottom: 15px; background-color: rgba(255,255,255,0.1); padding:10px; border-radius: 8px;}
        #game6-host .alien-status { display: flex; justify-content: space-around; align-items: center; margin-bottom: 15px; }
        #game6-host .alien-icon { font-size: 3.5em; animation: float 3s infinite ease-in-out; }
        @keyframes float { 0%, 100% {transform: translateY(0) rotate(-3deg);} 50% {transform: translateY(-8px) rotate(3deg);} }
        #game6-host .position-text, #game6-host .target-text { font-size: 1.2em; }
        #game6-host .fuel-info { background-color: #00bcd4; /* Cyan fuel */ color: #006064; padding: 8px 15px; border-radius: 20px; font-size: 1.6em; font-weight: bold; margin-bottom: 20px; display: inline-block; box-shadow: 0 0 12px #00bcd4; }
        #game6-host .jump-options { display: flex; justify-content: space-around; width: 100%; flex-wrap: wrap; gap: 10px;}
        #game6-host .jump-option { background-color: #ffb300; /* Amber */ color: #424242; padding: 15px; border-radius: 10px; font-size: 1.5em; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; min-width: 80px; text-align: center;}
        #game6-host .jump-option:hover { transform: scale(1.05); box-shadow: 0 0 15px #ffecb3; }
        #game6-host .number-path-container { margin-top: 15px; background-color: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px; overflow-x: auto; white-space: nowrap; }
        #game6-host .path-segment { display: inline-block; padding: 3px 6px; margin: 0 2px; background-color: #424242; color: #e0e0e0; border-radius: 3px; font-size: 0.9em;}
        #game6-host .path-segment.current { background-color: #00bcd4; color: black; font-weight: bold;}
        #game6-host .path-segment.target { background-color: #ffb300; color: black; font-weight: bold;}


        /* --- Styles for Game 7 (Fruit Stand - Money) --- */
        #game7-host .game-container { background-color: #a5d6a7; /* Light Green */ border: 5px solid #388e3c; /* Darker Green border */ padding: 20px; border-radius: 15px; max-width: 500px; width: 95%; text-align: center; }
        #game7-host .player-money { font-size: 1.6em; margin-bottom: 15px; color: #1b5e20; background-color: #e8f5e9; padding:10px; border-radius:10px; display:inline-block; }
        #game7-host .items-for-sale { display: flex; justify-content: space-around; align-items: flex-start; margin-bottom: 20px; }
        #game7-host .fruit-item { text-align: center; background-color: rgba(255,255,255,0.5); padding: 10px; border-radius: 10px; width: 45%;}
        #game7-host .fruit-icon { font-size: 3.5em; margin-bottom: 5px; }
        #game7-host .fruit-price { font-size: 1.4em; font-weight: bold; color: #c62828; /* Dark Red price */ }
        #game7-host .purchase-question { font-size: 1.5em; margin-bottom: 20px; color: #3e2723; }
        #game7-host .choice-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; width: 100%; }
        #game7-host .choice-option { background-color: #ff8f00; /* Orange */ color: white; padding: 15px; border-radius: 10px; font-size: 1.2em; cursor: pointer; transition: transform 0.2s, background-color 0.2s; text-align: center; }
        #game7-host .choice-option:hover { transform: scale(1.03); background-color: #e65100; }

        /* Game Over Overlay Styles (Unchanged) */
        #game-over-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; font-size: 2em; text-align: center; opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0s 0.5s; }
        #game-over-overlay.show { opacity: 1; visibility: visible; transition: opacity 0.5s ease; }
        #game-over-overlay button { font-size: 0.8em; padding: 10px 20px; margin-top: 20px; background-color: #ffc107; color: black; border: none; border-radius: 8px; cursor: pointer; }
        
        /* Media Queries (Adjust if needed for new layouts) */
        @media (max-width: 500px) {
            body { padding: 10px; }
            /* Game 2 styles from before */
            .game23-more-challenging-btn { font-size: 14px; padding: 8px 12px; }
            .game23-game-container { padding: 10px; }
            .game23-shape { font-size: 24px; }
            .game23-shape-icon { font-size: 20px; }
            .game23-number-option { width: 35px; height: 35px; font-size: 18px; }
            .game-result-emoji { font-size: 80px; }
            .game-result-text { font-size: 28px; }
            .game23-operator { font-size: 32px; }
            .game23-timer { font-size: 24px; min-width: 80px; }
            /* Game 5 */
            #game5-host .problem-area { font-size: 1.8em; }
            #game5-host .potion-option { font-size: 1.4em; padding: 15px; }
            /* Game 6 */
            #game6-host .mission-info {font-size: 1.1em;}
            #game6-host .alien-icon { font-size: 3em; }
            #game6-host .fuel-info { font-size: 1.3em; }
            #game6-host .jump-option { font-size: 1.2em; padding: 12px; min-width: 60px; }
            /* Game 7 */
            #game7-host .player-money {font-size: 1.3em;}
            #game7-host .fruit-icon { font-size: 3em; }
            #game7-host .purchase-question { font-size: 1.2em;}
            #game7-host .choice-option { font-size: 1em; padding: 12px;}
        }

    </style>
</head>
<body>

    <div id="game-selector-area">
        <button id="select-game2">Shapes Count</button> <!-- Original Game 2 -->
        <button id="select-game5">Potion Helper</button> <!-- Formerly Game 5, now Missing Addend -->
        <button id="select-game6">Alien Jumps</button>  <!-- Formerly Game 6, now Jumps to Target -->
        <button id="select-game7">Fruit Money</button> <!-- Formerly Game 7, now Money Decisions -->
    </div>

    <div id="score-area">
        <span id="remaining-tries-display">Tries: 50</span>
        <span id="current-score-display">Score: 0/50</span>
    </div>

    <div id="game-content-area">
        <!-- Game 2 Host (Shapes Math 1 - Original) -->
        <div id="game2-host" class="game-host-container" style="display: none;">
            <button class="game23-more-challenging-btn" id="game2-more-challenging-btn">More Challenging</button>
            <div class="game23-game-container">
                <div class="game23-timer" id="game2-timer">10:00</div>
                <div class="game23-shapes-container">
                    <div class="game23-shape-group" id="game2-shape-group-1"></div>
                    <div class="game23-shape-group" id="game2-shape-group-2"></div>
                </div>
                <div class="game23-math-container">
                    <div class="game23-math-row"><div class="game23-shape-icon" id="game2-icon-1"></div><div class="game23-number-options" id="game2-options-1"></div></div>
                    <div class="game23-math-row"><div class="game23-operator">+</div></div>
                    <div class="game23-math-row"><div class="game23-shape-icon" id="game2-icon-2"></div><div class="game23-number-options" id="game2-options-2"></div></div>
                    <div class="game23-math-row"><div class="game23-operator">=</div></div>
                    <div class="game23-math-row"><div class="game23-number-options" id="game2-options-sum"></div></div>
                </div>
            </div>
            <div class="game-result-popup" id="game2-result">
                <div class="game-result-emoji" id="game2-result-emoji"></div><div class="game-result-text" id="game2-result-text"></div>
            </div>
        </div>

        <!-- Game 5 Host (Potion - Missing Addend) -->
        <div id="game5-host" class="game-host-container" style="display: none;">
            <div class="game-container">
                <div class="problem-area">
                    <span class="cauldron-icon">üîÆ</span>
                    <span id="game5-val1" class="ingredient">3</span>
                    <span id="game5-op1">+</span>
                    <span id="game5-qmark" class="missing-ingredient">?</span>
                    <span id="game5-op2">=</span>
                    <span id="game5-total" class="potion-total">7</span>
                </div>
                <div id="game5-options-grid" class="options-grid">
                    <!-- Potion options for missing addend -->
                </div>
            </div>
            <div class="game-result-popup" id="game5-result">
                <div class="game-result-emoji" id="game5-result-emoji"></div>
                <div class="game-result-text" id="game5-result-text"></div>
            </div>
        </div>

        <!-- Game 6 Host (Alien Rescue - Jumps) -->
        <div id="game6-host" class="game-host-container" style="display: none;">
            <div class="game-container">
                <div class="mission-info">
                    Help the Alien reach the Target Planet!
                    <div id="game6-number-path-container" class="number-path-container">
                        <!-- Number path segments will be generated here -->
                    </div>
                </div>
                <div class="alien-status">
                    <span class="alien-icon">üõ∏</span>
                    <div>
                        <div id="game6-current-pos" class="position-text">Alien at: 5</div>
                        <div id="game6-target-pos" class="target-text">Target: 12</div>
                    </div>
                    <span class="alien-icon">ü™ê</span>
                </div>
                <div id="game6-fuel-info" class="fuel-info">Each Jump: +2</div>
                <div class="purchase-question">How many jumps?</div>
                <div id="game6-jump-options" class="jump-options">
                    <!-- Jump options (1, 2, 3, 4 jumps) -->
                </div>
            </div>
            <div class="game-result-popup" id="game6-result">
                <div class="game-result-emoji" id="game6-result-emoji"></div>
                <div class="game-result-text" id="game6-result-text"></div>
            </div>
        </div>
        
        <!-- Game 7 Host (Fruit Stand - Money Decisions) -->
        <div id="game7-host" class="game-host-container" style="display: none;">
            <div class="game-container">
                <div id="game7-player-money" class="player-money">You have üí∞10 coins.</div>
                <div class="items-for-sale">
                    <div class="fruit-item" id="game7-item1-details">
                        <div id="game7-fruit1-icon" class="fruit-icon">üçé</div>
                        <div id="game7-fruit1-name">Apple</div>
                        <div id="game7-fruit1-price" class="fruit-price">3 coins</div>
                    </div>
                    <div class="fruit-item" id="game7-item2-details">
                        <div id="game7-fruit2-icon" class="fruit-icon">üçå</div>
                        <div id="game7-fruit2-name">Banana</div>
                        <div id="game7-fruit2-price" class="fruit-price">4 coins</div>
                    </div>
                </div>
                <div id="game7-purchase-question" class="purchase-question">What can you buy?</div>
                <div id="game7-choice-options" class="choice-options">
                    <!-- Purchase choice options -->
                </div>
            </div>
            <div class="game-result-popup" id="game7-result">
                <div class="game-result-emoji" id="game7-result-emoji"></div>
                <div class="game-result-text" id="game7-result-text"></div>
            </div>
        </div>

    </div> <!-- End game-content-area -->

    <div id="game-over-overlay">
        <div id="game-over-message">Game Over!</div>
        <div id="final-score-display">Your score: 0/50</div>
        <button id="restart-all-button">Play Again</button>
    </div>

    <script>
        // --- Global Score and State (Identical to previous) ---
        const TOTAL_ALLOWED_TRIES = 50;
        let remainingTries = TOTAL_ALLOWED_TRIES;
        let currentScore = 0;
        let activeGame = null;
        let gamePausedForFeedback = false;

        const remainingTriesDisplay = document.getElementById('remaining-tries-display');
        const currentScoreDisplay = document.getElementById('current-score-display');
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const gameOverMessage = document.getElementById('game-over-message');
        const finalScoreDisplay = document.getElementById('final-score-display');
        const restartAllButton = document.getElementById('restart-all-button');

        const gameSelectorButtons = {
            game2: document.getElementById('select-game2'), // Shapes Math 1
            game5: document.getElementById('select-game5'), // Potion Helper (Missing Addend)
            game6: document.getElementById('select-game6'), // Alien Jumps
            game7: document.getElementById('select-game7'), // Fruit Money
        };

        // --- Utility Functions (Identical) ---
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } }
        function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        // --- Score Management (Identical) ---
        function updateScoreDisplay() { remainingTriesDisplay.textContent = `Tries: ${remainingTries}`; currentScoreDisplay.textContent = `Score: ${currentScore}/${TOTAL_ALLOWED_TRIES}`; }
        function recordAttempt(isCorrect) { if (remainingTries <= 0) return false; remainingTries--; if (isCorrect) { currentScore++; } updateScoreDisplay(); checkGameOver(); return !isGameOver(); }
        function isGameOver() { return remainingTries <= 0 || currentScore >= TOTAL_ALLOWED_TRIES; }
        function checkGameOver() { if (isGameOver()) { if (activeGame && activeGame.cleanup) { activeGame.cleanup(); } gameOverMessage.textContent = currentScore >= TOTAL_ALLOWED_TRIES ? 'üéâ Awesome! You reached 50! üéâ' : 'Game Over! Try again?'; finalScoreDisplay.textContent = `Your score: ${currentScore}/${TOTAL_ALLOWED_TRIES}`; gameOverOverlay.classList.add('show'); Object.values(gameSelectorButtons).forEach(btn => btn.disabled = true); return true; } return false; }
        function resetGlobalScoreAndRestartApp() { remainingTries = TOTAL_ALLOWED_TRIES; currentScore = 0; updateScoreDisplay(); gameOverOverlay.classList.remove('show'); gamePausedForFeedback = false; Object.values(gameSelectorButtons).forEach(btn => btn.disabled = false); if (activeGame) { switchGame(activeGame.id); } else { switchGame('game2'); } } // Default to game2
        restartAllButton.addEventListener('click', resetGlobalScoreAndRestartApp);

        // --- Game Switching (Updated for new games) ---
        function switchGame(gameId) {
            if (gamePausedForFeedback || isGameOver()) return;
            if (activeGame && activeGame.cleanup) { activeGame.cleanup(); }

            document.querySelectorAll('.game-host-container').forEach(host => host.style.display = 'none');
            Object.values(gameSelectorButtons).forEach(btn => btn.classList.remove('active'));

            let gameToStart;
            switch (gameId) {
                case 'game2': gameToStart = game2; break;
                case 'game5': gameToStart = game5; break;
                case 'game6': gameToStart = game6; break;
                case 'game7': gameToStart = game7; break;
            }

            if (gameToStart) {
                document.getElementById(`${gameId}-host`).style.display = 'flex';
                gameSelectorButtons[gameId].classList.add('active');
                activeGame = gameToStart;
                if (activeGame.init) activeGame.init();
            }
        }
        
        function showGameResult(gameElements, isSuccess, customText = null) { // Allow custom text for more complex feedback
            gamePausedForFeedback = true;
            gameElements.resultDiv.classList.remove('show'); // Ensure it's hidden
             // Add a slight delay for the removal to process if it was already showing, then add 'show'
            requestAnimationFrame(() => {
                requestAnimationFrame(() => { // Nested to ensure proper sequencing
                    if (isSuccess) {
                        const goodEmojis = ['üòÑüå∏', 'üéâ‚ú®', 'üëçüíñ', 'üåüüòä', 'ü•≥üéà'];
                        gameElements.resultEmoji.textContent = goodEmojis[getRandomInt(0, goodEmojis.length-1)];
                        gameElements.resultText.textContent = customText || 'Super Job!';
                        gameElements.resultText.style.color = '#27ae60';
                    } else {
                        const tryAgainEmojis = ['üò¢üåµ', 'üòüüíß', 'ü§îüí®', 'üò¨üå™Ô∏è'];
                        gameElements.resultEmoji.textContent = tryAgainEmojis[getRandomInt(0, tryAgainEmojis.length-1)];
                        gameElements.resultText.textContent = customText || 'Try Again!';
                        gameElements.resultText.style.color = '#e74c3c';
                    }
                    gameElements.resultDiv.classList.add('show');
                });
            });
        }

        // --- Game 2 (Shapes Math 1 - Original) ---
        // This code is assumed to be largely the same as your previous fully working version for Game 2.
        // Make sure its `showResult` calls the global `showGameResult` and handles `gamePausedForFeedback`.
        const game2 = {
            id: 'game2', hostElement: document.getElementById('game2-host'),
            config: { shapeTypes: ['üçé', '‚≠ê', 'üåà', 'üéà', 'üöÄ', 'üåª', 'üéÅ', 'üç¶', 'ü¶Ñ', 'üçï'], maxShapes: 5, INITIAL_TIMER_DURATION: 10, MIN_TIMER_DURATION: 2, },
            state: { currentShape1: '', currentShape2: '', count1: 0, count2: 0, sumCount: 0, selectedNumbers: [null, null, null], timerInterval: null, timeLeft: 0, centisecondsLeft: 0, currentTimerDuration: 0 },
            elements: {},
            init: function() { 
                this.state.currentTimerDuration = this.config.INITIAL_TIMER_DURATION;
                this.elements.shapeGroup1 = this.hostElement.querySelector('#game2-shape-group-1');
                this.elements.shapeGroup2 = this.hostElement.querySelector('#game2-shape-group-2');
                this.elements.icon1 = this.hostElement.querySelector('#game2-icon-1');
                this.elements.icon2 = this.hostElement.querySelector('#game2-icon-2');
                this.elements.options1 = this.hostElement.querySelector('#game2-options-1');
                this.elements.options2 = this.hostElement.querySelector('#game2-options-2');
                this.elements.optionsSum = this.hostElement.querySelector('#game2-options-sum');
                this.elements.resultDiv = this.hostElement.querySelector('#game2-result'); // Generic class
                this.elements.resultEmoji = this.hostElement.querySelector('#game2-result-emoji'); // Generic class
                this.elements.resultText = this.hostElement.querySelector('#game2-result-text');   // Generic class
                this.elements.timerDisplay = this.hostElement.querySelector('#game2-timer');
                this.elements.moreChallengingBtn = this.hostElement.querySelector('#game2-more-challenging-btn');
                this.elements.moreChallengingBtn.removeEventListener('click', this.handleMoreChallenging); // Remove old if any
                this.elements.moreChallengingBtn.addEventListener('click', this.handleMoreChallenging.bind(this));
                this.startGameCycle();
            },
            handleMoreChallenging: function() { if (isGameOver()) return; if (this.state.currentTimerDuration > this.config.MIN_TIMER_DURATION) { this.state.currentTimerDuration--; } else { this.elements.moreChallengingBtn.textContent = `Min Time (${this.config.MIN_TIMER_DURATION}s)!`; setTimeout(() => { this.elements.moreChallengingBtn.textContent = 'More Challenging'; }, 1000); } this.cleanupTimer(); this.startGameCycle(); },
            startGameCycle: function() { if (isGameOver()) return; gamePausedForFeedback = false; this.state.selectedNumbers = [null, null, null]; this.clearShapesAndOptions(); const shapeIndex1 = Math.floor(Math.random() * this.config.shapeTypes.length); let shapeIndex2 = Math.floor(Math.random() * this.config.shapeTypes.length); while (shapeIndex2 === shapeIndex1) { shapeIndex2 = Math.floor(Math.random() * this.config.shapeTypes.length); } this.state.currentShape1 = this.config.shapeTypes[shapeIndex1]; this.state.currentShape2 = this.config.shapeTypes[shapeIndex2]; this.state.count1 = Math.floor(Math.random() * this.config.maxShapes) + 1; this.state.count2 = Math.floor(Math.random() * this.config.maxShapes) + 1; this.state.sumCount = this.state.count1 + this.state.count2; this.displayShapes(this.elements.shapeGroup1, this.state.currentShape1, this.state.count1); this.displayShapes(this.elements.shapeGroup2, this.state.currentShape2, this.state.count2); this.elements.icon1.textContent = this.state.currentShape1; this.elements.icon2.textContent = this.state.currentShape2; this.generateNumberOptions(this.elements.options1, this.state.count1, 0); this.generateNumberOptions(this.elements.options2, this.state.count2, 1); this.generateNumberOptions(this.elements.optionsSum, this.state.sumCount, 2); this.startTimer(); },
            displayShapes: function(container, shapeType, count) { container.innerHTML = ''; for (let i = 0; i < count; i++) { const shapeElem = document.createElement('div'); shapeElem.className = 'game23-shape'; shapeElem.textContent = shapeType; container.appendChild(shapeElem); } },
            clearShapesAndOptions: function() { this.elements.shapeGroup1.innerHTML = ''; this.elements.shapeGroup2.innerHTML = ''; this.elements.options1.innerHTML = ''; this.elements.options2.innerHTML = ''; this.elements.optionsSum.innerHTML = ''; },
            generateNumberOptions: function(container, correctNumber, rowIndex) { container.innerHTML = ''; const numbers = [correctNumber]; const maxPossibleOption = this.config.maxShapes * 2; while (numbers.length < 3) { let randomNum = Math.floor(Math.random() * Math.min(10, maxPossibleOption)) + 1; if (Math.random() > 0.5) { randomNum = Math.floor(Math.random() * maxPossibleOption) + 1; } if (!numbers.includes(randomNum) && randomNum > 0) { numbers.push(randomNum); } } shuffleArray(numbers); numbers.forEach(num => { const optionElem = document.createElement('div'); optionElem.className = 'game23-number-option'; optionElem.textContent = num; optionElem.addEventListener('click', () => { if (gamePausedForFeedback || isGameOver()) return; this.selectNumber(optionElem, num, rowIndex, container); }); container.appendChild(optionElem); }); },
            selectNumber: function(element, number, rowIndex, container) { const siblings = container.getElementsByClassName('game23-number-option'); for (let i = 0; i < siblings.length; i++) { siblings[i].classList.remove('selected', 'wrong'); } element.classList.add('selected'); this.state.selectedNumbers[rowIndex] = number; if (this.state.selectedNumbers.every(num => num !== null)) { this.checkAnswer(); } },
            checkAnswer: function() { if (gamePausedForFeedback || isGameOver()) return; this.cleanupTimer(); gamePausedForFeedback = true; const isFirstCorrect = this.state.selectedNumbers[0] === this.state.count1; const isSecondCorrect = this.state.selectedNumbers[1] === this.state.count2; const isSumCorrect = this.state.selectedNumbers[2] === this.state.sumCount; const allCorrect = isFirstCorrect && isSecondCorrect && isSumCorrect; const canContinue = recordAttempt(allCorrect); if (allCorrect) { showGameResult(this.elements, true); setTimeout(() => { this.elements.resultDiv.classList.remove('show'); if (canContinue) this.startGameCycle(); else gamePausedForFeedback = false; }, 1500); } else { showGameResult(this.elements, false); if (!isFirstCorrect && this.state.selectedNumbers[0] !== null) this.markWrongOption(this.elements.options1, this.state.selectedNumbers[0]); if (!isSecondCorrect && this.state.selectedNumbers[1] !== null) this.markWrongOption(this.elements.options2, this.state.selectedNumbers[1]); if (!isSumCorrect && this.state.selectedNumbers[2] !== null) this.markWrongOption(this.elements.optionsSum, this.state.selectedNumbers[2]); setTimeout(() => { this.elements.resultDiv.classList.remove('show'); if (canContinue) this.resetSelectionsForRetry(); else gamePausedForFeedback = false; }, 1500); } },
            markWrongOption: function(container, selectedValue) { const options = container.getElementsByClassName('game23-number-option'); for(let option of options) { if (parseInt(option.textContent) === selectedValue && option.classList.contains('selected')) { option.classList.add('wrong'); break; } } },
            resetSelectionsForRetry: function() { gamePausedForFeedback = false; this.state.selectedNumbers = [null, null, null]; const allOptions = this.hostElement.getElementsByClassName('game23-number-option'); for (let i = 0; i < allOptions.length; i++) { allOptions[i].classList.remove('selected', 'wrong'); } if (!isGameOver()) this.startTimer(); },
            startTimer: function() { if (isGameOver()) return; this.state.timeLeft = this.state.currentTimerDuration; this.state.centisecondsLeft = 0; this.updateTimerDisplay(); this.cleanupTimer(); this.state.timerInterval = setInterval(() => { this.state.centisecondsLeft -= 10; if (this.state.centisecondsLeft < 0) { this.state.centisecondsLeft = 90; this.state.timeLeft--; } this.updateTimerDisplay(); if (this.state.timeLeft < 0) { this.cleanupTimer(); gamePausedForFeedback = true; const canContinue = recordAttempt(false); showGameResult(this.elements, false, "Time's Up!"); setTimeout(() => { this.elements.resultDiv.classList.remove('show'); if (canContinue) this.startGameCycle(); else gamePausedForFeedback = false; }, 2000); } }, 100); },
            updateTimerDisplay: function() { const displaySeconds = String(Math.max(0, this.state.timeLeft)).padStart(2, '0'); const displayCentiseconds = String(Math.max(0, this.state.centisecondsLeft)).padStart(2, '0'); this.elements.timerDisplay.textContent = `${displaySeconds}:${displayCentiseconds}`; },
            cleanupTimer: function() { if (this.state.timerInterval) clearInterval(this.state.timerInterval); this.state.timerInterval = null; },
            cleanup: function() { this.cleanupTimer(); if (this.elements.resultDiv) this.elements.resultDiv.classList.remove('show'); gamePausedForFeedback = false; }
        };

        // --- Game 5: Potion Helper (Missing Addend) ---
        const game5 = {
            id: 'game5',
            hostElement: document.getElementById('game5-host'),
            state: { val1: 0, val2: 0, total:0, missingVal: 0, missingPosition: 0 }, // 0 for val1, 1 for val2
            elements: {},
            init: function() {
                this.elements.val1 = this.hostElement.querySelector('#game5-val1');
                this.elements.op1 = this.hostElement.querySelector('#game5-op1');
                this.elements.qmark = this.hostElement.querySelector('#game5-qmark');
                this.elements.op2 = this.hostElement.querySelector('#game5-op2');
                this.elements.total = this.hostElement.querySelector('#game5-total');
                this.elements.optionsGrid = this.hostElement.querySelector('#game5-options-grid');
                this.elements.resultDiv = this.hostElement.querySelector('#game5-result');
                this.elements.resultEmoji = this.hostElement.querySelector('#game5-result-emoji');
                this.elements.resultText = this.hostElement.querySelector('#game5-result-text');
                this.startGameCycle();
            },
            startGameCycle: function() {
                if (isGameOver()) return;
                gamePausedForFeedback = false;
                
                this.state.val1 = getRandomInt(1, 8); // Keep numbers small for missing addend
                this.state.val2 = getRandomInt(1, 8);
                this.state.total = this.state.val1 + this.state.val2;

                this.state.missingPosition = Math.random() < 0.5 ? 0 : 1; // 0 means val1 is missing, 1 means val2 is missing

                if (this.state.missingPosition === 0) { // ? + val2 = total
                    this.state.missingVal = this.state.val1;
                    this.elements.val1.style.display = 'none';
                    this.elements.qmark.style.display = 'inline-block';
                    this.elements.op1.textContent = '+';
                    this.elements.qmark.after(this.elements.op1); // Ensure ? is first visible
                    this.elements.op1.after(this.elements.val2);
                    this.elements.val2.textContent = this.state.val2;
                    this.elements.val2.style.display = 'inline-block';
                } else { // val1 + ? = total
                    this.state.missingVal = this.state.val2;
                    this.elements.val1.textContent = this.state.val1;
                    this.elements.val1.style.display = 'inline-block';
                    this.elements.qmark.style.display = 'inline-block';
                    this.elements.op1.textContent = '+';
                    this.elements.val1.after(this.elements.op1);
                    this.elements.op1.after(this.elements.qmark);
                    this.elements.val2.style.display = 'none';
                }
                this.elements.op2.textContent = '=';
                this.elements.total.textContent = this.state.total;

                this.displayOptions();
            },
            displayOptions: function() {
                this.elements.optionsGrid.innerHTML = '';
                let options = [this.state.missingVal];
                while (options.length < 3) {
                    let distractor = this.state.missingVal + getRandomInt(-2, 2);
                    if (distractor > 0 && distractor <= 9 && distractor !== this.state.missingVal && !options.includes(distractor)) {
                        options.push(distractor);
                    } else { // Fallback
                        distractor = getRandomInt(1,9);
                        if (distractor !== this.state.missingVal && !options.includes(distractor)) options.push(distractor);
                    }
                }
                shuffleArray(options);

                options.forEach(opt => {
                    const button = document.createElement('div');
                    button.classList.add('potion-option');
                    button.textContent = opt;
                    button.addEventListener('click', () => this.checkAnswer(opt));
                    this.elements.optionsGrid.appendChild(button);
                });
            },
            checkAnswer: function(selectedAnswer) {
                if (gamePausedForFeedback || isGameOver()) return;
                const isCorrect = selectedAnswer === this.state.missingVal;
                const canContinue = recordAttempt(isCorrect);
                showGameResult(this.elements, isCorrect);
                setTimeout(() => {
                    this.elements.resultDiv.classList.remove('show');
                    if (canContinue) this.startGameCycle();
                    else gamePausedForFeedback = false;
                }, 1500);
            },
            cleanup: function() { if (this.elements.resultDiv) this.elements.resultDiv.classList.remove('show'); gamePausedForFeedback = false; }
        };

        // --- Game 6: Alien Jumps ---
        const game6 = {
            id: 'game6', hostElement: document.getElementById('game6-host'),
            state: { currentPos: 0, targetPos: 0, jumpVal: 0, jumpOp: '+', correctJumps: 0, maxPath: 20 },
            elements: {},
            init: function() {
                this.elements.currentPosDisplay = this.hostElement.querySelector('#game6-current-pos');
                this.elements.targetPosDisplay = this.hostElement.querySelector('#game6-target-pos');
                this.elements.fuelInfo = this.hostElement.querySelector('#game6-fuel-info');
                this.elements.jumpOptions = this.hostElement.querySelector('#game6-jump-options');
                this.elements.resultDiv = this.hostElement.querySelector('#game6-result');
                this.elements.resultEmoji = this.hostElement.querySelector('#game6-result-emoji');
                this.elements.resultText = this.hostElement.querySelector('#game6-result-text');
                this.elements.numberPathContainer = this.hostElement.querySelector('#game6-number-path-container');
                this.startGameCycle();
            },
            renderNumberPath: function() {
                this.elements.numberPathContainer.innerHTML = '';
                const pathStart = Math.max(0, Math.min(this.state.currentPos, this.state.targetPos) - 3);
                const pathEnd = Math.min(this.state.maxPath, Math.max(this.state.currentPos, this.state.targetPos) + 3);
                for (let i = pathStart; i <= pathEnd; i++) {
                    const segment = document.createElement('span');
                    segment.classList.add('path-segment');
                    segment.textContent = i;
                    if (i === this.state.currentPos) segment.classList.add('current');
                    if (i === this.state.targetPos) segment.classList.add('target');
                    this.elements.numberPathContainer.appendChild(segment);
                }
            },
            startGameCycle: function() {
                if (isGameOver()) return;
                gamePausedForFeedback = false;
                this.state.jumpVal = getRandomInt(1, 3);
                this.state.jumpOp = Math.random() < 0.5 ? '+' : '-';
                
                let numJumps = getRandomInt(2, 4); // Number of jumps to make the problem
                this.state.correctJumps = numJumps;

                if (this.state.jumpOp === '+') {
                    this.state.currentPos = getRandomInt(0, this.state.maxPath - (numJumps * this.state.jumpVal) -1); // Ensure target isn't too high
                    this.state.targetPos = this.state.currentPos + (numJumps * this.state.jumpVal);
                } else { // Subtraction
                    this.state.currentPos = getRandomInt((numJumps * this.state.jumpVal)+1, this.state.maxPath); // Ensure currentPos is high enough
                    this.state.targetPos = this.state.currentPos - (numJumps * this.state.jumpVal);
                }
                // Ensure target is not negative
                if(this.state.targetPos < 0) this.state.targetPos = 0;


                this.elements.currentPosDisplay.textContent = `Alien at: ${this.state.currentPos}`;
                this.elements.targetPosDisplay.textContent = `Target: ${this.state.targetPos}`;
                this.elements.fuelInfo.textContent = `Each Jump: ${this.state.jumpOp}${this.state.jumpVal}`;
                this.renderNumberPath();
                this.displayOptions();
            },
            displayOptions: function() {
                this.elements.jumpOptions.innerHTML = '';
                let options = [this.state.correctJumps];
                // Generate options like 1 jump, 2 jumps etc.
                while (options.length < 4) { // Fixed 4 options for jump counts
                    let distractor = this.state.correctJumps + getRandomInt(-2, 2);
                    if (distractor > 0 && distractor <= 5 && distractor !== this.state.correctJumps && !options.includes(distractor)) {
                        options.push(distractor);
                    } else { // Fallback ensure some options
                        let r = getRandomInt(1,5);
                        if(!options.includes(r)) options.push(r);
                    }
                     options = Array.from(new Set(options)); // Remove duplicates
                }
                shuffleArray(options);

                options.forEach(opt => {
                    const button = document.createElement('div');
                    button.classList.add('jump-option');
                    button.textContent = `${opt} Jump${opt > 1 ? 's':''}`;
                    button.dataset.jumps = opt; // Store the jump count
                    button.addEventListener('click', () => this.checkAnswer(parseInt(button.dataset.jumps)));
                    this.elements.jumpOptions.appendChild(button);
                });
            },
            checkAnswer: function(selectedJumps) {
                if (gamePausedForFeedback || isGameOver()) return;
                const isCorrect = selectedJumps === this.state.correctJumps;
                const canContinue = recordAttempt(isCorrect);
                showGameResult(this.elements, isCorrect);
                setTimeout(() => {
                    this.elements.resultDiv.classList.remove('show');
                    if (canContinue) this.startGameCycle();
                    else gamePausedForFeedback = false;
                }, 1500);
            },
            cleanup: function() { if (this.elements.resultDiv) this.elements.resultDiv.classList.remove('show'); gamePausedForFeedback = false;}
        };

        // --- Game 7: Fruit Money ---
        const game7 = {
            id: 'game7', hostElement: document.getElementById('game7-host'),
            state: { playerMoney: 0, item1: {name:"", price:0, icon:""}, item2: {name:"", price:0, icon:""}, correctAnswer: "",
                     fruitData: [ {name:"Apple",icon:"üçé"}, {name:"Banana",icon:"üçå"}, {name:"Orange",icon:"üçä"}, {name:"Grapes",icon:"üçá"}, {name:"Pear",icon:"üçê"} ] },
            elements: {},
            init: function() {
                this.elements.playerMoneyDisplay = this.hostElement.querySelector('#game7-player-money');
                this.elements.item1Icon = this.hostElement.querySelector('#game7-fruit1-icon');
                this.elements.item1Name = this.hostElement.querySelector('#game7-fruit1-name');
                this.elements.item1Price = this.hostElement.querySelector('#game7-fruit1-price');
                this.elements.item2Icon = this.hostElement.querySelector('#game7-fruit2-icon');
                this.elements.item2Name = this.hostElement.querySelector('#game7-fruit2-name');
                this.elements.item2Price = this.hostElement.querySelector('#game7-fruit2-price');
                this.elements.questionDisplay = this.hostElement.querySelector('#game7-purchase-question');
                this.elements.choiceOptions = this.hostElement.querySelector('#game7-choice-options');
                this.elements.resultDiv = this.hostElement.querySelector('#game7-result');
                this.elements.resultEmoji = this.hostElement.querySelector('#game7-result-emoji');
                this.elements.resultText = this.hostElement.querySelector('#game7-result-text');
                this.startGameCycle();
            },
            startGameCycle: function() {
                if (isGameOver()) return;
                gamePausedForFeedback = false;
                this.state.playerMoney = getRandomInt(5, 12); // Player has 5-12 coins

                // Select two different fruits
                let fruit1Idx = getRandomInt(0, this.state.fruitData.length - 1);
                let fruit2Idx = getRandomInt(0, this.state.fruitData.length - 1);
                while (fruit2Idx === fruit1Idx) fruit2Idx = getRandomInt(0, this.state.fruitData.length - 1);

                this.state.item1 = {...this.state.fruitData[fruit1Idx], price: getRandomInt(2, 6)};
                this.state.item2 = {...this.state.fruitData[fruit2Idx], price: getRandomInt(2, 6)};
                // Ensure prices aren't identical if items are different
                if (this.state.item1.price === this.state.item2.price && this.state.item1.name !== this.state.item2.name) {
                    this.state.item2.price = getRandomInt(2,6); // reroll one price
                     if (this.state.item1.price === this.state.item2.price) this.state.item2.price +=1; // simple adjustment
                }


                this.elements.playerMoneyDisplay.textContent = `You have üí∞${this.state.playerMoney} coins.`;
                this.elements.item1Icon.textContent = this.state.item1.icon;
                this.elements.item1Name.textContent = this.state.item1.name;
                this.elements.item1Price.textContent = `${this.state.item1.price} coins`;
                this.elements.item2Icon.textContent = this.state.item2.icon;
                this.elements.item2Name.textContent = this.state.item2.name;
                this.elements.item2Price.textContent = `${this.state.item2.price} coins`;
                
                this.generatePurchaseScenario();
            },
            generatePurchaseScenario: function() {
                const canBuyItem1 = this.state.playerMoney >= this.state.item1.price;
                const canBuyItem2 = this.state.playerMoney >= this.state.item2.price;
                const canBuyBoth = this.state.playerMoney >= (this.state.item1.price + this.state.item2.price);
                
                let scenarioType = getRandomInt(1,3); // 3 types of questions
                let options = [];
                let questionText = "";

                if (scenarioType === 1 || (!canBuyItem1 && !canBuyItem2)) { // "What can you buy?"
                    questionText = "What can you afford?";
                    if (canBuyBoth) { this.state.correctAnswer = "Both"; options.push("Both");}
                    if (canBuyItem1) { options.push(this.state.item1.name); if(!canBuyBoth && canBuyItem1 && !options.includes(this.state.item1.name)) this.state.correctAnswer = this.state.item1.name;} // If only one, it's correct
                    if (canBuyItem2) { options.push(this.state.item2.name); if(!canBuyBoth && canBuyItem2 && !options.includes(this.state.item2.name)) this.state.correctAnswer = this.state.item2.name;}
                    
                    if (!canBuyItem1 && !canBuyItem2) {this.state.correctAnswer = "Nothing"; options.push("Nothing");}
                    else if (!canBuyBoth && canBuyItem1 && canBuyItem2) { // Can buy individually but not both
                        this.state.correctAnswer = `${this.state.item1.name} OR ${this.state.item2.name}`; // Special case for display
                        options.push(this.state.correctAnswer);
                         options = options.filter(opt => opt !== this.state.item1.name && opt !== this.state.item2.name); // remove individual if OR is an option
                    }


                    // Add distractors
                    if (!options.includes("Nothing") && !canBuyItem1 && !canBuyItem2) options.push("Nothing");
                    if (this.state.item1.name !== this.state.item2.name && !options.includes("Both") && (canBuyItem1 || canBuyItem2)) options.push("Both");


                } else if (scenarioType === 2 && canBuyItem1) { // "Change for item 1?"
                    questionText = `Buy ${this.state.item1.name}. Change?`;
                    this.state.correctAnswer = this.state.playerMoney - this.state.item1.price;
                    options.push(this.state.correctAnswer);
                    options.push(this.state.correctAnswer + getRandomInt(1,2));
                    options.push(Math.max(0, this.state.correctAnswer - getRandomInt(1,2)));

                } else if (scenarioType === 3 && canBuyItem2) { // "Change for item 2?" (fallback if scenario 2 not possible)
                     questionText = `Buy ${this.state.item2.name}. Change?`;
                    this.state.correctAnswer = this.state.playerMoney - this.state.item2.price;
                    options.push(this.state.correctAnswer);
                    options.push(this.state.correctAnswer + getRandomInt(1,2));
                    options.push(Math.max(0, this.state.correctAnswer - getRandomInt(1,2)));
                } else { // Fallback to "What can you buy?" if specific change questions are not viable
                     questionText = "What can you afford?";
                    if (canBuyBoth) { this.state.correctAnswer = "Both"; options.push("Both");}
                    if (canBuyItem1) { options.push(this.state.item1.name); if(!canBuyBoth && canBuyItem1 && !options.includes(this.state.item1.name)) this.state.correctAnswer = this.state.item1.name;}
                    if (canBuyItem2) { options.push(this.state.item2.name); if(!canBuyBoth && canBuyItem2 && !options.includes(this.state.item2.name)) this.state.correctAnswer = this.state.item2.name;}
                     if (!canBuyItem1 && !canBuyItem2) {this.state.correctAnswer = "Nothing"; options.push("Nothing");}
                     else if (!canBuyBoth && canBuyItem1 && canBuyItem2) {
                        this.state.correctAnswer = `${this.state.item1.name} OR ${this.state.item2.name}`;
                        options.push(this.state.correctAnswer);
                         options = options.filter(opt => opt !== this.state.item1.name && opt !== this.state.item2.name);
                    }
                }
                
                this.elements.questionDisplay.textContent = questionText;
                this.displayChoiceOptions(options.filter((v,i,a)=>a.indexOf(v)===i)); // Unique options
            },
            displayChoiceOptions: function(optionsArray) {
                this.elements.choiceOptions.innerHTML = '';
                // Ensure there are always 2-4 unique options
                let finalOptions = Array.from(new Set(optionsArray)); // Unique
                while (finalOptions.length < 2) { // Need at least 2
                    if (typeof this.state.correctAnswer === 'number') { // if it's a change question
                        finalOptions.push(getRandomInt(0, this.state.playerMoney));
                    } else { // if it's a "what to buy" question
                        if(!finalOptions.includes("Nothing")) finalOptions.push("Nothing");
                        else if (!finalOptions.includes(this.state.item1.name)) finalOptions.push(this.state.item1.name)
                        else if (!finalOptions.includes(this.state.item2.name)) finalOptions.push(this.state.item2.name)
                        else finalOptions.push("Both") // last resort
                    }
                    finalOptions = Array.from(new Set(finalOptions));
                }
                if(finalOptions.length > 4) finalOptions = finalOptions.slice(0,4); // Max 4 options
                
                shuffleArray(finalOptions);

                finalOptions.forEach(optText => {
                    const button = document.createElement('div');
                    button.classList.add('choice-option');
                    button.textContent = (typeof optText === 'number') ? `üí∞${optText}` : optText;
                    button.dataset.choice = optText;
                    button.addEventListener('click', () => this.checkAnswer(button.dataset.choice));
                    this.elements.choiceOptions.appendChild(button);
                });
            },
            checkAnswer: function(selectedChoice) {
                if (gamePausedForFeedback || isGameOver()) return;
                let isCorrect;
                // For "OR" scenario, check if selected is one of the items
                if (String(this.state.correctAnswer).includes("OR")) {
                     const items = this.state.correctAnswer.split(" OR ");
                     isCorrect = items.includes(selectedChoice);
                } else if (typeof this.state.correctAnswer === 'number') { // Change question
                    isCorrect = parseInt(selectedChoice) === this.state.correctAnswer;
                } else { // String comparison for item names/Both/Nothing
                    isCorrect = selectedChoice === this.state.correctAnswer;
                }

                const canContinue = recordAttempt(isCorrect);
                showGameResult(this.elements, isCorrect);
                setTimeout(() => {
                    this.elements.resultDiv.classList.remove('show');
                    if (canContinue) this.startGameCycle();
                    else gamePausedForFeedback = false;
                }, 1500);
            },
            cleanup: function() { if (this.elements.resultDiv) this.elements.resultDiv.classList.remove('show'); gamePausedForFeedback = false; }
        };

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateScoreDisplay();
            Object.keys(gameSelectorButtons).forEach(gameKey => {
                gameSelectorButtons[gameKey].addEventListener('click', () => switchGame(gameKey));
            });
            switchGame('game2'); // Start with Shapes Math 1
        });
    </script>
</body>
</html>