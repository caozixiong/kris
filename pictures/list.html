<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€’å½’å›¾ç‰‡ç”»å»Š</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .debug-info {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            display: none;
        }
        .debug-toggle {
            margin: 0 auto 20px;
            display: block;
            padding: 5px 10px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }
        .breadcrumb {
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .breadcrumb a {
            color: #0366d6;
            text-decoration: none;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        .folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            grid-gap: 15px;
            margin-bottom: 20px;
        }
        .folder-item {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .folder-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .folder-icon {
            font-size: 40px;
            color: #0366d6;
        }
        .folder-name {
            margin-top: 10px;
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            grid-gap: 20px;
        }
        .gallery-item {
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: white;
            transition: transform 0.3s ease;
        }
        .gallery-item:hover {
            transform: translateY(-5px);
        }
        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        .image-info {
            padding: 10px;
        }
        .image-name {
            margin: 0;
            font-size: 16px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .path-info {
            margin: 5px 0 0 0;
            font-size: 12px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #0366d6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .back-to-top:hover {
            background-color: #0353b4;
        }
    </style>
</head>
<body>
    <h1>é€’å½’å›¾ç‰‡ç”»å»Š</h1>
    
    <button id="debugToggle" class="debug-toggle">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
    <div id="debugInfo" class="debug-info"></div>
    
    <div id="breadcrumb" class="breadcrumb">
        <a href="#" data-path="">é¦–é¡µ</a>
    </div>
    <div id="folders" class="folder-grid"></div>
    <div id="gallery" class="gallery">
        <div class="loading">æ­£åœ¨åŠ è½½å†…å®¹...</div>
    </div>
    <button id="backToTop" class="back-to-top" title="è¿”å›é¡¶éƒ¨">â†‘</button>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const galleryElement = document.getElementById('gallery');
            const foldersElement = document.getElementById('folders');
            const breadcrumbElement = document.getElementById('breadcrumb');
            const backToTopButton = document.getElementById('backToTop');
            const debugInfoElement = document.getElementById('debugInfo');
            const debugToggleButton = document.getElementById('debugToggle');
            
            // è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºå¼€å…³
            debugToggleButton.addEventListener('click', function() {
                if (debugInfoElement.style.display === 'none' || debugInfoElement.style.display === '') {
                    debugInfoElement.style.display = 'block';
                    debugToggleButton.textContent = 'éšè—è°ƒè¯•ä¿¡æ¯';
                } else {
                    debugInfoElement.style.display = 'none';
                    debugToggleButton.textContent = 'æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯';
                }
            });
            
            // æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
            const imgExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
            
            // å½“å‰è·¯å¾„
            let currentPath = '';
            
            // è®°å½•è°ƒè¯•ä¿¡æ¯çš„å‡½æ•°
            function logDebug(message, data = null) {
                const timestamp = new Date().toLocaleTimeString();
                let logMessage = `[${timestamp}] ${message}`;
                
                if (data) {
                    if (typeof data === 'object') {
                        try {
                            logMessage += "\n" + JSON.stringify(data, null, 2);
                        } catch (e) {
                            logMessage += "\n[æ— æ³•åºåˆ—åŒ–æ•°æ®]";
                        }
                    } else {
                        logMessage += "\n" + data;
                    }
                }
                
                debugInfoElement.textContent += logMessage + "\n\n";
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                debugInfoElement.scrollTop = debugInfoElement.scrollHeight;
                console.log(message, data);
            }
            
            // åˆå§‹åŒ–
            logDebug("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–");
            loadDirectory(currentPath);
            
            // å¤„ç†é¢åŒ…å±‘å¯¼èˆªç‚¹å‡»
            breadcrumbElement.addEventListener('click', function(e) {
                e.preventDefault();
                if (e.target.tagName === 'A') {
                    currentPath = e.target.getAttribute('data-path');
                    logDebug(`å¯¼èˆªåˆ°è·¯å¾„: ${currentPath}`);
                    loadDirectory(currentPath);
                }
            });
            
            // å¤„ç†è¿”å›é¡¶éƒ¨æŒ‰é’®
            window.addEventListener('scroll', function() {
                if (window.pageYOffset > 300) {
                    backToTopButton.style.display = 'block';
                } else {
                    backToTopButton.style.display = 'none';
                }
            });
            
            backToTopButton.addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // åŠ è½½æŒ‡å®šç›®å½•
            function loadDirectory(path) {
                galleryElement.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å†…å®¹...</div>';
                foldersElement.innerHTML = '';
                
                // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
                updateBreadcrumb(path);
                
                // æ„å»ºè¯·æ±‚URL - ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                const requestUrl = path ? path + '/' : '.';
                logDebug(`å‡†å¤‡è¯·æ±‚URL: ${requestUrl}`);
                
                // è®°å½•å½“å‰é¡µé¢URLä¿¡æ¯ï¼Œå¸®åŠ©è°ƒè¯•
                logDebug("é¡µé¢URLä¿¡æ¯", {
                    href: window.location.href,
                    pathname: window.location.pathname,
                    protocol: window.location.protocol,
                    host: window.location.host
                });
                
                fetch(requestUrl)
                    .then(response => {
                        logDebug(`æ”¶åˆ°å“åº”: ${response.status} ${response.statusText}`);
                        return response.text();
                    })
                    .then(html => {
                        // æ¸…é™¤åŠ è½½ä¿¡æ¯
                        galleryElement.innerHTML = '';
                        
                        // åˆ›å»ºä¸´æ—¶DOMå…ƒç´ æ¥è§£æå“åº”
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        // è®°å½•è§£æåçš„HTMLç»“æ„ï¼ˆèŠ‚é€‰ï¼‰
                        logDebug("è§£æHTMLå“åº”", {
                            title: doc.title,
                            bodyLength: doc.body ? doc.body.innerHTML.length : 0,
                            linkCount: doc.querySelectorAll('a').length
                        });
                        
                        // è·å–æ‰€æœ‰é“¾æ¥
                        const links = doc.querySelectorAll('a');
                        
                        // å­˜å‚¨å½“å‰ç›®å½•çš„æ–‡ä»¶å¤¹å’Œå›¾ç‰‡
                        const folders = [];
                        const images = [];
                        
                        // å¤„ç†é“¾æ¥
                        links.forEach(link => {
                            const href = link.getAttribute('href');
                            // è·³è¿‡æ— æ•ˆé“¾æ¥ã€çˆ¶ç›®å½•é“¾æ¥å’Œé”šç‚¹é“¾æ¥
                            if (!href || href === '../' || href === './' || href.startsWith('#')) {
                                return;
                            }
                            
                            // æ„å»ºå®Œæ•´è·¯å¾„
                            const fullPath = path ? `${path}/${href}` : href;
                            logDebug(`å‘ç°é“¾æ¥: ${href}, å®Œæ•´è·¯å¾„: ${fullPath}`);
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶å¤¹ï¼ˆä»¥/ç»“å°¾ï¼‰
                            if (href.endsWith('/')) {
                                // ç§»é™¤å°¾éƒ¨æ–œæ ä»¥è·å¾—æ–‡ä»¶å¤¹å
                                const folderName = href.slice(0, -1);
                                folders.push({
                                    name: folderName,
                                    path: fullPath.slice(0, -1)
                                });
                                logDebug(`æ·»åŠ æ–‡ä»¶å¤¹: ${folderName}`);
                            } 
                            // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡
                            else if (imgExtensions.some(ext => href.toLowerCase().endsWith(ext))) {
                                images.push({
                                    name: href,
                                    path: fullPath,
                                    directory: path || 'æ ¹ç›®å½•'
                                });
                                logDebug(`æ·»åŠ å›¾ç‰‡: ${href}`);
                            }
                        });
                        
                        // æ±‡æ€»ä¿¡æ¯
                        logDebug(`å‘ç° ${folders.length} ä¸ªæ–‡ä»¶å¤¹å’Œ ${images.length} å¼ å›¾ç‰‡`);
                        
                        // æ˜¾ç¤ºæ–‡ä»¶å¤¹
                        if (folders.length > 0) {
                            folders.forEach(folder => {
                                const folderElement = createFolderElement(folder);
                                foldersElement.appendChild(folderElement);
                            });
                        }
                        
                        // æ˜¾ç¤ºå›¾ç‰‡
                        if (images.length > 0) {
                            images.forEach(image => {
                                const imageElement = createImageElement(image);
                                galleryElement.appendChild(imageElement);
                            });
                        } else if (folders.length === 0) {
                            galleryElement.innerHTML = '<div class="loading">å½“å‰ç›®å½•æ²¡æœ‰å›¾ç‰‡</div>';
                        }
                        
                        // å¦‚æœæ²¡æœ‰å†…å®¹
                        if (folders.length === 0 && images.length === 0) {
                            galleryElement.innerHTML = '<div class="loading">å½“å‰ç›®å½•ä¸ºç©º</div>';
                            logDebug("ç›®å½•ä¸ºç©ºï¼Œå°è¯•ç›´æ¥åˆ—å‡ºä¸€äº›å¸¸è§æ–‡ä»¶åç§°");
                            
                            // å°è¯•ç›´æ¥æŸ¥æ‰¾ä¸€äº›å¸¸è§çš„å›¾ç‰‡åç§°
                            const commonNames = ['test.jpg', 'image.png', 'photo.jpg', 'screenshot.png', 'pic.jpg'];
                            commonNames.forEach(name => {
                                fetch(path ? `${path}/${name}` : name)
                                    .then(response => {
                                        if (response.ok) {
                                            logDebug(`æ‰¾åˆ°ç›´æ¥è®¿é—®çš„å›¾ç‰‡: ${name}`);
                                            const image = {
                                                name: name,
                                                path: path ? `${path}/${name}` : name,
                                                directory: path || 'æ ¹ç›®å½•'
                                            };
                                            const imageElement = createImageElement(image);
                                            if (galleryElement.querySelector('.loading')) {
                                                galleryElement.innerHTML = '';
                                            }
                                            galleryElement.appendChild(imageElement);
                                        }
                                    })
                                    .catch(() => { /* å¿½ç•¥é”™è¯¯ */ });
                            });
                        }
                    })
                    .catch(error => {
                        console.error('åŠ è½½ç›®å½•å†…å®¹æ—¶å‡ºé”™:', error);
                        logDebug(`åŠ è½½ç›®å½•å†…å®¹æ—¶å‡ºé”™: ${error.message}`);
                        galleryElement.innerHTML = '<div class="loading">åŠ è½½ç›®å½•å†…å®¹æ—¶å‡ºé”™</div>';
                        
                        // æ·»åŠ ä¸€ä¸ªå°è¯•æŒ‰é’®
                        const retryButton = document.createElement('button');
                        retryButton.textContent = 'é‡è¯•åŠ è½½';
                        retryButton.style.display = 'block';
                        retryButton.style.margin = '20px auto';
                        retryButton.style.padding = '10px 20px';
                        retryButton.addEventListener('click', () => loadDirectory(currentPath));
                        galleryElement.appendChild(retryButton);
                    });
            }
            
            // åˆ›å»ºæ–‡ä»¶å¤¹å…ƒç´ 
            function createFolderElement(folder) {
                const item = document.createElement('div');
                item.className = 'folder-item';
                item.setAttribute('data-path', folder.path);
                
                const icon = document.createElement('div');
                icon.className = 'folder-icon';
                icon.textContent = 'ğŸ“';
                
                const name = document.createElement('div');
                name.className = 'folder-name';
                name.textContent = folder.name;
                
                item.appendChild(icon);
                item.appendChild(name);
                
                // ç‚¹å‡»æ–‡ä»¶å¤¹æ—¶å¯¼èˆªåˆ°è¯¥æ–‡ä»¶å¤¹
                item.addEventListener('click', function() {
                    currentPath = folder.path;
                    logDebug(`ç‚¹å‡»æ–‡ä»¶å¤¹ï¼Œå¯¼èˆªåˆ°: ${currentPath}`);
                    loadDirectory(currentPath);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                
                return item;
            }
            
            // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            function createImageElement(image) {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                const img = document.createElement('img');
                img.src = image.path;
                img.alt = image.name;
                img.loading = 'lazy'; // å»¶è¿ŸåŠ è½½
                
                // æ·»åŠ å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
                img.onerror = function() {
                    logDebug(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${image.path}`);
                    img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect width="200" height="200" fill="%23f0f0f0"/><text x="50%" y="50%" font-family="Arial" font-size="16" text-anchor="middle" fill="%23999">åŠ è½½å¤±è´¥</text></svg>';
                    img.style.background = '#f0f0f0';
                };
                
                img.onload = function() {
                    logDebug(`å›¾ç‰‡åŠ è½½æˆåŠŸ: ${image.path}`);
                };
                
                const info = document.createElement('div');
                info.className = 'image-info';
                
                const name = document.createElement('h3');
                name.className = 'image-name';
                name.textContent = image.name;
                
                const pathInfo = document.createElement('p');
                pathInfo.className = 'path-info';
                pathInfo.textContent = image.directory;
                
                info.appendChild(name);
                info.appendChild(pathInfo);
                item.appendChild(img);
                item.appendChild(info);
                
                // ç‚¹å‡»å›¾ç‰‡æ—¶å…¨å±æ˜¾ç¤º
                item.addEventListener('click', function() {
                    logDebug(`ç‚¹å‡»å›¾ç‰‡: ${image.path}`);
                    window.open(image.path, '_blank');
                });
                
                return item;
            }
            
            // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
            function updateBreadcrumb(path) {
                // æ¸…é™¤ç°æœ‰å¯¼èˆªï¼ˆä¿ç•™é¦–é¡µï¼‰
                while (breadcrumbElement.childNodes.length > 1) {
                    breadcrumbElement.removeChild(breadcrumbElement.lastChild);
                }
                
                // å¦‚æœä¸æ˜¯æ ¹ç›®å½•ï¼Œåˆ›å»ºè·¯å¾„å¯¼èˆª
                if (path) {
                    const parts = path.split('/');
                    let currentPath = '';
                    
                    parts.forEach((part, index) => {
                        // æ·»åŠ åˆ†éš”ç¬¦
                        breadcrumbElement.appendChild(document.createTextNode(' > '));
                        
                        // æ„å»ºå½“å‰éƒ¨åˆ†çš„å®Œæ•´è·¯å¾„
                        currentPath += (index > 0 ? '/' : '') + part;
                        
                        // åˆ›å»ºé“¾æ¥
                        const link = document.createElement('a');
                        link.href = '#';
                        link.setAttribute('data-path', currentPath);
                        link.textContent = part;
                        breadcrumbElement.appendChild(link);
                    });
                }
                
                logDebug(`æ›´æ–°é¢åŒ…å±‘å¯¼èˆª: ${path || 'æ ¹ç›®å½•'}`);
            }
            
            // æ£€æµ‹æ˜¯å¦åœ¨GitHub Pagesç¯å¢ƒä¸­
            if (window.location.hostname.includes('github.io')) {
                logDebug("æ£€æµ‹åˆ°GitHub Pagesç¯å¢ƒ");
                
                // æ‰«ææ‰€æœ‰å¸¸è§å­ç›®å½•
                const commonDirs = ['images', 'img', 'photos', 'pictures', 'pics', 'assets'];
                commonDirs.forEach(dir => {
                    fetch(dir)
                        .then(response => {
                            if (response.ok) {
                                logDebug(`å‘ç°æœ‰æ•ˆç›®å½•: ${dir}`);
                                const folderItem = {
                                    name: dir,
                                    path: dir
                                };
                                const folderElement = createFolderElement(folderItem);
                                foldersElement.appendChild(folderElement);
                            }
                        })
                        .catch(() => { /* å¿½ç•¥é”™è¯¯ */ });
                });
            }
        });
    </script>
</body>
</html>
